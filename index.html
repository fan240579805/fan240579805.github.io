<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>给最珍贵的你</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    
    <style>
        /* --- 全局样式 --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI 层通用 --- */
        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            pointer-events: none;
        }

        /* --- 第一阶段：道歉信 UI --- */
        #intro-layer {
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1.5s ease-in-out;
            pointer-events: auto;
        }

        .text-container {
            width: 80%;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            line-height: 2;
            min-height: 150px;
            text-align: left;
            white-space: pre-wrap;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            font-family: 'Ma Shan Zheng', cursive; 
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: white;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        .enter-btn {
            margin-top: 50px;
            padding: 12px 35px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 30px;
            font-size: 1.1rem;
            font-family: 'Ma Shan Zheng', cursive;
            cursor: pointer;
            opacity: 0; 
            transition: all 0.5s;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        .enter-btn:active {
            background: rgba(255,255,255,0.1);
            transform: scale(0.95);
        }

        /* --- 第二阶段：3D 画布 --- */
        #canvas-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            opacity: 0; 
            transition: opacity 2s;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
        }

        /* --- 第三阶段：拍立得弹窗 --- */
        #polaroid-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 30;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            background: rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            transition: opacity 0.5s;
            pointer-events: none;
        }

        .polaroid {
            position: relative;
            width: 280px;
            background: #fff;
            padding: 15px 15px 45px 15px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            transform: scale(0.8) rotate(-3deg);
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            border-radius: 4px;
            pointer-events: auto;
        }
        
        .polaroid.active {
            transform: scale(1) rotate(0deg);
        }

        .polaroid img.main-photo {
            width: 100%;
            height: auto;
            display: block;
            background: #f8f8f8;
            margin-bottom: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            min-height: 200px;
            object-fit: cover;
        }

        .radish-deco {
            position: absolute;
            width: 75px; 
            height: auto;
            z-index: 10;
            filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.2));
            top: -30px;
            right: -25px;
            transform: rotate(15deg);
            pointer-events: none;
        }

        .polaroid-text {
            width: 100%;
            text-align: center;
            color: #333;
            font-family: 'Ma Shan Zheng', cursive; 
        }

        .polaroid-title { font-size: 1.5rem; margin-bottom: 8px; color: #2c3e50; }
        .polaroid-sub { font-size: 1.1rem; color: #555; line-height: 1.4; margin-bottom: 10px; }
        .polaroid-date { position: absolute; bottom: 15px; right: 20px; font-size: 0.9rem; color: #999; font-family: 'Ma Shan Zheng', cursive; }

        .close-hint {
            position: absolute;
            bottom: -60px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- 终章：求原谅弹窗 --- */
        #final-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 40;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 1s;
        }
        
        .apology-card {
            width: 85%;
            max-width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.4);
            transform: scale(0.8);
            animation: popIn 0.5s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Ma Shan Zheng', cursive;
        }

        .cute-star-icon {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
            /* 哭泣动画 */
            animation: shake 3s infinite; 
        }

        .apology-title { font-size: 1.6rem; color: #333; margin-bottom: 15px; font-weight: bold; }
        .apology-body { font-size: 1.1rem; color: #555; line-height: 1.6; margin-bottom: 30px; }

        .choice-btn {
            display: block;
            width: 100%;
            padding: 12px 0;
            margin-bottom: 15px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-family: 'Ma Shan Zheng', cursive;
            cursor: pointer;
            transition: transform 0.2s;
            color: white;
        }
        .btn-primary { background: linear-gradient(45deg, #ff9a9e, #fad0c4); box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4); }
        .btn-secondary { background: linear-gradient(45deg, #a18cd1, #fbc2eb); box-shadow: 0 4px 15px rgba(161, 140, 209, 0.4); }
        .choice-btn:active { transform: scale(0.95); }

        /* --- 终章Part 2: 信封与信件 --- */
        #envelope-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: none; justify-content: center; align-items: center;
            pointer-events: none; 
        }

        .envelope-container {
            width: 200px; height: 140px;
            background: #f3f3f3;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            cursor: pointer;
            animation: floatEnvelope 3s ease-in-out infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.5s, opacity 0.5s;
            pointer-events: auto;
        }
        .envelope-container:after {
            content: '♥'; font-size: 40px; color: #d35400;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .envelope-hint {
            position: absolute; bottom: -40px; width: 200%; left: -50%;
            text-align: center; color: white; font-family: 'Ma Shan Zheng', cursive;
            font-size: 1rem; animation: pulse 2s infinite;
        }

        /* 信纸 - 优化滚动 */
        #letter-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 60; background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 1s;
        }
        .letter-paper {
            width: 85%; max-width: 400px;
            max-height: 70vh; /* 限制高度 */
            background: #fffdf5; 
            background-image: linear-gradient(#e4e4e4 1px, transparent 1px);
            background-size: 100% 2rem; 
            padding: 30px 20px; /* 调整内边距 */
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.1rem;
            line-height: 2rem;
            color: #444;
            overflow-y: auto; /* 开启滚动 */
            pointer-events: auto; /* 确保可以交互 */
            -webkit-overflow-scrolling: touch; /* 优化iOS滚动 */
            transform: translateY(50px);
            transition: transform 1s;
        }
        /* 信纸底部留白，防止文字贴底 */
        #letter-content {
            padding-bottom: 50px;
        }

        /* 引导提示 & 刷新按钮 */
        #guide-hint { position: absolute; bottom: 10%; width: 100%; text-align: center; color: rgba(255,255,255,0.6); font-size: 1rem; z-index: 10; pointer-events: none; animation: pulse 2s infinite; display: none; font-family: 'Ma Shan Zheng', cursive; }
        
        /* 刷新按钮 - 提高层级，确保不被遮挡 */
        .refresh-container { 
            position: absolute; 
            bottom: 30px; 
            right: 30px; 
            z-index: 100; /* 提高层级，超过信封层(50)和信纸层(60) */
            display: none; 
            flex-direction: column; 
            align-items: center; 
        }
        #refresh-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; pointer-events: auto; backdrop-filter: blur(5px); transition: transform 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #refresh-btn:active { transform: rotate(180deg) scale(0.9); }
        
        /* Toast */
        .toast-container { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); z-index: 110; pointer-events: none; }
        .toast { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.3); color: #fff; padding: 10px 24px; border-radius: 50px; font-family: 'Ma Shan Zheng', cursive; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-20px); transition: all 0.4s; white-space: nowrap; }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* 抓捕提示文字 */
        #catch-hint {
            position: absolute; top: 20%; width: 100%; text-align: center;
            color: #ffec8b; font-size: 1.2rem; text-shadow: 0 0 10px #ffec8b;
            font-family: 'Ma Shan Zheng', cursive; display: none; pointer-events: none;
            animation: pulse 0.5s infinite alternate; z-index: 15;
        }

        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulse { 0% { opacity: 0.5; transform: scale(1); } 100% { opacity: 1; transform: scale(1.05); } }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        @keyframes floatEnvelope { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <!-- 1. 道歉信层 -->
    <div id="intro-layer" class="ui-layer">
        <div class="text-container">
            <span id="typewriter-text"></span><span class="cursor"></span>
        </div>
        <button class="enter-btn" id="enter-btn" onclick="startGalaxy()">去寻找遗失的光</button>
    </div>

    <!-- 2. 3D 场景 -->
    <div id="canvas-container"></div>
    <div id="guide-hint">拖动星空 · 点击发光的星星</div>
    <div id="catch-hint">有一颗流星想要逃跑！<br>快抓住它！</div>
    
    <!-- 刷新按钮 (层级已调高，永远可见) -->
    <div class="refresh-container" id="refresh-ui">
        <div id="refresh-btn" onclick="refreshMemories()">↻</div>
    </div>

    <div class="toast-container"><div id="toast" class="toast"></div></div>

    <!-- 3. 拍立得层 -->
    <div id="polaroid-modal" onclick="closePolaroid()">
        <div class="polaroid" id="polaroid-card" onclick="event.stopPropagation()">
            <img id="p-img" class="main-photo" src="" alt="" onerror="handleImageError(this)">
            <img id="p-radish" class="radish-deco" src="" style="display:none" onerror="this.style.display='none'">
            <div class="polaroid-text">
                <div class="polaroid-title" id="p-title"></div>
                <div class="polaroid-sub" id="p-sub"></div>
            </div>
            <div class="polaroid-date" id="p-date"></div>
            <div class="close-hint">点击背景关闭</div>
        </div>
    </div>

    <!-- 4. 终章：哭泣星星求原谅 -->
    <div id="final-modal">
        <div class="apology-card">
            <!-- 重新设计的超级可爱哭泣星星 SVG -->
            <img src="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cdefs%3E%3CradialGradient id='glow' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' stop-color='%23FFEB3B'/%3E%3Cstop offset='100%25' stop-color='%23FFC107'/%3E%3C/radialGradient%3E%3Cfilter id='soft' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeGaussianBlur stdDeviation='2' result='blur'/%3E%3CfeComposite in='SourceGraphic' in2='blur' operator='over'/%3E%3C/filter%3E%3C/defs%3E%3C!-- 星星主体 (圆润版) --%3E%3Cpath d='M100 20 C105 20 115 55 120 60 C140 65 180 70 180 80 C180 90 150 110 145 120 C150 140 160 180 150 185 C140 190 105 160 100 160 C95 160 60 190 50 185 C40 180 50 140 55 120 C50 110 20 90 20 80 C20 70 60 65 80 60 C85 55 95 20 100 20 Z' fill='url(%23glow)' stroke='%23FFA000' stroke-width='4' stroke-linejoin='round' filter='url(%23soft)'/%3E%3C!-- 大眼睛 --%3E%3Ccircle cx='70' cy='95' r='12' fill='%23212121'/%3E%3Ccircle cx='130' cy='95' r='12' fill='%23212121'/%3E%3C!-- 眼神光 --%3E%3Ccircle cx='66' cy='90' r='4' fill='white'/%3E%3Ccircle cx='126' cy='90' r='4' fill='white'/%3E%3C!-- 委屈的嘴巴 --%3E%3Cpath d='M85 125 Q100 115 115 125' stroke='%23E65100' stroke-width='3' fill='none' stroke-linecap='round'/%3E%3C!-- 腮红 --%3E%3Cellipse cx='55' cy='110' rx='8' ry='5' fill='%23FF7043' opacity='0.6'/%3E%3Cellipse cx='145' cy='110' rx='8' ry='5' fill='%23FF7043' opacity='0.6'/%3E%3C!-- 泪珠 --%3E%3Cpath d='M65 110 Q60 125 65 140 Q70 125 65 110' fill='%234FC3F7' opacity='0.9'/%3E%3Cpath d='M135 110 Q140 125 135 140 Q130 125 135 110' fill='%234FC3F7' opacity='0.9'/%3E%3C/svg%3E" class="cute-star-icon" alt="cute crying star">
            
            <div class="apology-title">呜呜...被你抓到啦</div>
            <div class="apology-body">
                我是流星小特使。<br>
                某人已经知道错了，哭得比我还惨。<br>
                他说以后再也不会让你受委屈了。<br>
                能不能...再信他一次？
            </div>
            <button class="choice-btn btn-primary" onclick="triggerFinale('forgive')">原谅他吧 ❤️</button>
            <button class="choice-btn btn-secondary" onclick="triggerFinale('chance')">看在你的面子上 ✨</button>
        </div>
    </div>

    <!-- 5. 终章：信封与信 -->
    <div id="envelope-layer">
        <div class="envelope-container" onclick="openLetter()">
            <div class="envelope-hint">点击打开</div>
        </div>
    </div>

    <!-- 信纸层：防止点击关闭 (event.stopPropagation 在 JS 中补充处理) -->
    <div id="letter-modal">
        <div class="letter-paper" onclick="event.stopPropagation()">
            <div id="letter-content"></div>
        </div>
    </div>

    <audio id="bgm" loop>
        <source src="https://music.163.com/song/media/outer/url?id=1387581250.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ================= 配置中心 =================
        const CONFIG = {
            introText: "对不起，\n你不理我的这几天\n天空好像都灰了。\n我不善言辞，\n所以把想说的话，藏在了这片星空里。\n每一颗发光的星星，\n都是我想你的瞬间。",
            
            // 触发条件：点击3次回忆
            triggerCount: 4,

            memoryPool: [
                { src: "https://wfiles.gtimg.cn/wupload/data/new_year/185fbb92db0050c98de53f3667a9312d/2851264f_JfX8ellH8wvhNCWr0mTwAGcU5Kegp4Er.jpg", title: "海边的风", note: "那天风很大，但我只听得见你的笑声。", date: "2023.01.14" },
                { src: "https://wfiles.gtimg.cn/wupload/data/new_year/185fbb92db0050c98de53f3667a9312d/2851264f_V1uWKBUSw1SYfVocL5Z-uiWBu0hH0tOl.jpg", title: "小笨蛋", note: "其实每次你说我笨的时候，我都觉得很幸福。", date: "2021.01.18" },
                // { src: "https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?w=600&q=80", title: "对不起嘛", note: "我知道错了，罚我带你去吃好吃的行不行？", date: "2023.10.15" },
                { src: "https://wfiles.gtimg.cn/wupload/data/new_year/185fbb92db0050c98de53f3667a9312d/2851264f_GklQh_L4fxvzcxNqb0L3-zBd1uLvFx6h.jpg", title: "涓咪", note: "以后我们也要养一只这样的猫，好不好？", date: "2020.01.15" },
                { src: "https://wfiles.gtimg.cn/wupload/data/new_year/185fbb92db0050c98de53f3667a9312d/2851264f_sajsLpdL1k9uEzl4gZPnX90-m3jcf32T.jpg", title: "你的侧脸", note: "百看不厌，想就这么一直看着你变老。", date: "2025.01.22" },
                { src: "https://wfiles.gtimg.cn/wupload/data/new_year/185fbb92db0050c98de53f3667a9312d/2851264f_EZkVQjmhGjZ16tk2K2_luqaKV7i31SAt.jpg", title: "毕业啦", note: "你送的毕业礼物，一直好好存着。", date: "2022.05.25" },
                { src: "https://wfiles.gtimg.cn/wupload/data/new_year/185fbb92db0050c98de53f3667a9312d/2851264f_cSyftOasaDiPSW35_uJfyJZASVSwxIic.jpg", title: "朦朦胧胧", note: "模糊的涓宝，洋溢着幸福，想以后你都这么快乐。", date: "2023.05.08" }  
            ],

            radishPool: [
                "https://img.icons8.com/stickers/100/flower-doodle.png", 
                "https://img.icons8.com/stickers/100/potted-plant-doodle.png",
                "https://img.icons8.com/fluency/96/cute-pumpkin.png"
            ],
            displayCount: 3,

            finalLetter: `亲爱的小涓宝：

不知不觉，我们已经牵手走过了六年的时光。这六年里的点点滴滴，是我生命里最珍贵的宝藏。

对不起，最近让你难过了。这段时间我一直在深刻反思，我意识到自己之前的行为有多么糟糕，那些狡辩和借口，不仅没有解决问题，反而刺痛了最爱我的你。

范文真的很爱很爱小涓宝，不想因为我的幼稚弄丢了这份感情。请相信我，这一次我绝不再只动嘴皮子，我会收起所有的借口，用实实在在的行动来证明。

我想重新把那个给足你安全感、让你安心依靠的我找回来。

给我个机会，让我用余生慢慢补偿，好吗？`
        };

        const PLACEHOLDER_IMG = "data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'%3e%3crect width='400' height='400' fill='%23fff0f5'/%3e%3ctext x='50%25' y='50%25' font-family='sans-serif' font-size='24' fill='%23ffb6c1' dominant-baseline='middle' text-anchor='middle'%3eLove Memory%3c/text%3e%3c/svg%3e";

        function handleImageError(img) { img.onerror = null; img.src = PLACEHOLDER_IMG; }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg; toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ================= 核心逻辑 =================

        const state = {
            sessionClickCount: 0, // 当前轮次点击次数
            isMeteorStage: false,
            isFinaleTriggered: false
        };

        // 1. 打字机
        const textEl = document.getElementById('typewriter-text');
        const enterBtn = document.getElementById('enter-btn');
        let charIndex = 0;
        function typeWriter() {
            if (charIndex < CONFIG.introText.length) {
                textEl.innerHTML += CONFIG.introText.charAt(charIndex) === '\n' ? '<br>' : CONFIG.introText.charAt(charIndex);
                charIndex++;
                setTimeout(typeWriter, 80 + Math.random() * 100);
            } else {
                document.querySelector('.cursor').style.display = 'none';
                enterBtn.style.opacity = 1;
                enterBtn.style.pointerEvents = 'auto';
            }
        }
        setTimeout(typeWriter, 1000);

        // 2. Three.js 场景
        let scene, camera, renderer;
        let starGroup;
        let activeMemoryStars = [];
        let ambientParticles, bgParticles;
        let meteorObject = null; 
        let meteorTrailSystem = null; 
        let fireworkSystem = null;
        let raycaster, mouse;
        let isDragging = false, previousTouch = {x:0, y:0}, rotationVelocity = {x:0, y:0};

        function startGalaxy() {
            document.getElementById('bgm').play().catch(()=>{});
            document.getElementById('intro-layer').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('intro-layer').style.display = 'none';
                document.getElementById('canvas-container').style.opacity = 1;
                document.getElementById('guide-hint').style.display = 'block';
                document.getElementById('refresh-ui').style.display = 'flex';
                initThreeJS();
                setTimeout(() => showToast("点击刷新可以重置星空哦 ↻"), 2000);
            }, 1500);
        }

        function initThreeJS() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.0015);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 4000);
            camera.position.z = 450;
            
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            starGroup = new THREE.Group();
            scene.add(starGroup);

            createAmbientParticles();
            createBackgroundStars();
            spawnMemoryStars();

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('resize', onResize);
            document.addEventListener('touchstart', onTouchStart, {passive: false});
            document.addEventListener('touchmove', onTouchMove, {passive: false});
            document.addEventListener('touchend', onTouchEnd, {passive: false});
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            renderer.domElement.addEventListener('click', onClick);

            animate();
        }

        function createLightTexture(colorStr = 'rgba(255,255,255,') {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,64,64);
            const grad = ctx.createRadialGradient(32,32,0, 32,32,32);
            grad.addColorStop(0, colorStr + '1)');
            grad.addColorStop(0.2, colorStr + '0.8)');
            grad.addColorStop(0.5, colorStr + '0.2)');
            grad.addColorStop(1.0, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,64,64);
            const tex = new THREE.CanvasTexture(canvas);
            tex.needsUpdate = true;
            return tex;
        }

        function createAmbientParticles() {
            const geom = new THREE.BufferGeometry();
            const vertices = [], colors = [];
            for(let i=0; i<4000; i++) {
                vertices.push((Math.random()-0.5)*2000, (Math.random()-0.5)*2000, (Math.random()-0.5)*2000);
                const c = new THREE.Color().setHSL(Math.random(), 0.2, 0.9);
                colors.push(c.r, c.g, c.b);
            }
            geom.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geom.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            const mat = new THREE.PointsMaterial({
                size: 4, vertexColors: true, transparent: true, opacity: 0.8,
                blending: THREE.AdditiveBlending, map: createLightTexture(), depthWrite: false
            });
            ambientParticles = new THREE.Points(geom, mat);
            starGroup.add(ambientParticles);
        }

        function createBackgroundStars() {
            const geom = new THREE.BufferGeometry();
            const vertices = [];
            for(let i=0; i<2000; i++) vertices.push((Math.random()-0.5)*4000, (Math.random()-0.5)*4000, (Math.random()-0.5)*4000);
            geom.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            bgParticles = new THREE.Points(geom, new THREE.PointsMaterial({color:0xffffff, size:2, transparent:true, opacity:0.6}));
            starGroup.add(bgParticles);
        }

        function spawnMemoryStars() {
            if(state.isMeteorStage) return; 
            activeMemoryStars.forEach(s => starGroup.remove(s));
            activeMemoryStars = [];

            // 简单随机抽取
            const indicesToUse = CONFIG.memoryPool.map((_,i)=>i).sort(()=>0.5-Math.random()).slice(0, CONFIG.displayCount);

            const texture = createLightTexture();
            const material = new THREE.SpriteMaterial({ map: texture, color: 0xffffff, transparent: true, opacity: 0, blending: THREE.AdditiveBlending });
            
            indicesToUse.forEach((idx, i) => {
                const data = CONFIG.memoryPool[idx];
                const phi = Math.PI * (3 - Math.sqrt(5));
                const y = 1 - (i / (indicesToUse.length - 1 || 1)) * 2;
                const r = Math.sqrt(1 - y*y);
                const theta = phi * i * 10;
                
                const star = new THREE.Sprite(material.clone());
                star.position.set(
                    Math.cos(theta)*r*200 + (Math.random()-0.5)*50,
                    y*200 + (Math.random()-0.5)*50,
                    Math.sin(theta)*r*200 + (Math.random()-0.5)*50
                );
                star.scale.set(1,1,1);
                star.userData = { isMemory: true, data: data };
                starGroup.add(star);
                activeMemoryStars.push(star);

                new TWEEN.Tween(star.material).to({opacity:0.9}, 1000).delay(i*200).start();
                new TWEEN.Tween(star.scale).to({x:40, y:40}, 1000).delay(i*200).easing(TWEEN.Easing.Back.Out).start();
                new TWEEN.Tween(star.scale).to({x:45, y:45}, 1500+Math.random()*500).yoyo(true).repeat(Infinity).delay(1000+i*200).start();
            });
        }

        // 刷新按钮逻辑：彻底重置
        function refreshMemories() {
            const btn = document.getElementById('refresh-btn');
            btn.style.transform = "rotate(360deg)";
            setTimeout(() => btn.style.transform = "rotate(0deg)", 500);

            // 重置所有流程
            resetGame();
        }

        // 完全重置游戏状态
        function resetGame() {
             state.isMeteorStage = false;
             state.isFinaleTriggered = false;
             state.sessionClickCount = 0;

             // 隐藏所有终章UI
             const finalModal = document.getElementById('final-modal');
             finalModal.style.display = 'none';
             finalModal.style.opacity = 0;

             const envelopeLayer = document.getElementById('envelope-layer');
             envelopeLayer.style.display = 'none';
             envelopeLayer.style.opacity = 0;

             const letterModal = document.getElementById('letter-modal');
             letterModal.style.display = 'none';
             letterModal.style.opacity = 0;
             document.querySelector('.letter-paper').style.transform = 'translateY(50px)';
             document.getElementById('letter-content').innerHTML = ''; // 清空信件

             // 移除流星和烟花
             if(meteorObject) { scene.remove(meteorObject); meteorObject = null; }
             if(meteorTrailSystem) { meteorTrailSystem.dispose(); meteorTrailSystem = null; }
             if(fireworkSystem) { scene.remove(fireworkSystem); fireworkSystem = null; }

             // 恢复引导提示
             document.getElementById('catch-hint').style.display = 'none';
             document.getElementById('guide-hint').style.display = 'block';
             
             // 重新生成回忆星星
             activeMemoryStars.forEach(star => {
                new TWEEN.Tween(star.scale).to({x:0,y:0}, 500).start();
                new TWEEN.Tween(star.material).to({opacity:0}, 500).start();
             });
             setTimeout(spawnMemoryStars, 600);
             
             showToast("一切重新开始 ↻");
        }

        function checkEndGame() {
            if(state.isMeteorStage) return;
            state.sessionClickCount++;
            
            if(state.sessionClickCount >= CONFIG.triggerCount) {
                state.isMeteorStage = true;
                setTimeout(startMeteorPhase, 1000);
            }
        }

        function startMeteorPhase() {
            activeMemoryStars.forEach(s => {
                new TWEEN.Tween(s.scale).to({x:0,y:0}, 1000).start();
                new TWEEN.Tween(s.material).to({opacity:0}, 1000).start();
            });
            activeMemoryStars = [];
            document.getElementById('guide-hint').style.display = 'none';

            const hint = document.getElementById('catch-hint');
            hint.style.display = 'block';
            hint.style.opacity = 1;

            spawnMeteor();
        }

        // 流星拖尾
        class MeteorTrail {
            constructor(scene) {
                this.particleCount = 40;
                this.geometry = new THREE.BufferGeometry();
                this.positions = new Float32Array(this.particleCount * 3);
                this.opacity = new Float32Array(this.particleCount);
                this.sizes = new Float32Array(this.particleCount);
                
                for(let i=0; i<this.particleCount; i++) {
                    this.positions[i*3] = 0; this.positions[i*3+1] = 0; this.positions[i*3+2] = 0;
                    this.opacity[i] = 0; this.sizes[i] = 0;
                }

                this.geometry.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));
                this.geometry.setAttribute('alpha', new THREE.BufferAttribute(this.opacity, 1));
                this.geometry.setAttribute('size', new THREE.BufferAttribute(this.sizes, 1));

                const texture = createLightTexture('rgba(255,215,0,');
                this.material = new THREE.ShaderMaterial({
                    uniforms: { pointTexture: { value: texture } },
                    vertexShader: `
                        attribute float alpha; attribute float size; varying float vAlpha;
                        void main() { vAlpha = alpha; vec4 mvPosition = modelViewMatrix * vec4(position, 1.0); gl_PointSize = size * (300.0 / -mvPosition.z); gl_Position = projectionMatrix * mvPosition; }
                    `,
                    fragmentShader: `
                        uniform sampler2D pointTexture; varying float vAlpha;
                        void main() { gl_FragColor = texture2D(pointTexture, gl_PointCoord); gl_FragColor.a *= vAlpha; }
                    `,
                    transparent: true, blending: THREE.AdditiveBlending, depthWrite: false
                });

                this.mesh = new THREE.Points(this.geometry, this.material);
                this.history = [];
                scene.add(this.mesh);
            }

            update(headPos) {
                this.history.unshift(headPos.clone());
                if(this.history.length > this.particleCount) this.history.pop();
                const posAttr = this.geometry.attributes.position;
                const alphaAttr = this.geometry.attributes.alpha;
                const sizeAttr = this.geometry.attributes.size;
                for(let i=0; i<this.history.length; i++) {
                    const p = this.history[i];
                    posAttr.setXYZ(i, p.x, p.y, p.z);
                    const life = 1 - (i / this.particleCount);
                    alphaAttr.setX(i, life * 0.6);
                    sizeAttr.setX(i, 60 * life);
                }
                for(let i=this.history.length; i<this.particleCount; i++) alphaAttr.setX(i, 0);
                posAttr.needsUpdate = true; alphaAttr.needsUpdate = true; sizeAttr.needsUpdate = true;
            }
            dispose() { scene.remove(this.mesh); }
        }

        function spawnMeteor() {
            const tex = createLightTexture('rgba(255, 215, 0,');
            const mat = new THREE.SpriteMaterial({ map: tex, color: 0xffd700, transparent: true, blending: THREE.AdditiveBlending });
            meteorObject = new THREE.Sprite(mat);
            meteorObject.scale.set(70, 70, 1);
            meteorObject.userData = { isMeteor: true };
            meteorObject.position.set(0, 0, 0);
            scene.add(meteorObject);
            meteorTrailSystem = new MeteorTrail(scene);

            new TWEEN.Tween(meteorObject.scale).from({x:0,y:0}).to({x:80, y:80}, 500).easing(TWEEN.Easing.Elastic.Out).start();
            new TWEEN.Tween(meteorObject.material).to({ opacity: 0.6 }, 300).yoyo(true).repeat(Infinity).start();
        }

        function onClick(event) {
            if(Math.abs(rotationVelocity.x) > 0.01 || Math.abs(rotationVelocity.y) > 0.01) return;
            let cx = event.clientX, cy = event.clientY;
            if(event.changedTouches && event.changedTouches.length > 0) { cx = event.changedTouches[0].clientX; cy = event.changedTouches[0].clientY; }
            mouse.x = (cx / window.innerWidth) * 2 - 1; mouse.y = -(cy / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            
            if(meteorObject) {
                const intersects = raycaster.intersectObject(meteorObject);
                if(intersects.length > 0) { catchMeteor(); return; }
            }
            if(!state.isMeteorStage) {
                const intersects = raycaster.intersectObjects(activeMemoryStars);
                if (intersects.length > 0) { openPolaroid(intersects[0].object); }
            }
        }

        function catchMeteor() {
            if(state.isFinaleTriggered) return;
            state.isFinaleTriggered = true;
            if(meteorTrailSystem) { meteorTrailSystem.dispose(); meteorTrailSystem = null; }
            new TWEEN.Tween(meteorObject.scale).to({x: 180, y: 180}, 500).easing(TWEEN.Easing.Quartic.Out).onComplete(() => { scene.remove(meteorObject); meteorObject = null; showFinalApology(); }).start();
            new TWEEN.Tween(meteorObject.material).to({opacity: 0}, 500).start();
            document.getElementById('catch-hint').style.display = 'none';
        }

        function showFinalApology() {
            const modal = document.getElementById('final-modal');
            modal.style.display = 'flex';
            void modal.offsetWidth; modal.style.opacity = 1;
        }

        window.triggerFinale = function(choice) {
            const modal = document.getElementById('final-modal');
            modal.style.opacity = 0;
            setTimeout(()=> modal.style.display='none', 1000);
            showToast(choice === 'forgive' ? "我会更加珍惜涓宝的 ✨" : "我会加倍对涓宝好的 ✨");
            setTimeout(launchHeartFireworks, 500);
        }

        function launchHeartFireworks() {
            const particleCount = 2500;
            const geom = new THREE.BufferGeometry();
            const positions = [], velocities = [], colors = [];
            for(let i=0; i<particleCount; i++) {
                positions.push(0, 0, 0);
                const t = Math.random() * Math.PI * 2;
                const scale = 13 + Math.random() * 4; 
                const hx = 16 * Math.pow(Math.sin(t), 3);
                const hy = 13 * Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t);
                const hz = (Math.random()-0.5) * 10; 
                velocities.push(hx * scale, hy * scale, hz * scale);
                const color = new THREE.Color().setHSL(0.9 + Math.random()*0.1, 1.0, 0.6);
                colors.push(color.r, color.g, color.b);
            }
            geom.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geom.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geom.userData = { velocities: velocities };
            const mat = new THREE.PointsMaterial({ size: 8, vertexColors: true, transparent: true, opacity: 1, blending: THREE.AdditiveBlending, map: createLightTexture(), depthWrite: false });
            fireworkSystem = new THREE.Points(geom, mat);
            scene.add(fireworkSystem);
        }

        function showEnvelope() {
            const el = document.getElementById('envelope-layer');
            el.style.display = 'flex'; el.style.pointerEvents = 'auto';
            // 确保信封透明度恢复
            el.style.opacity = 1; 
        }

        window.openLetter = function() {
            document.getElementById('envelope-layer').style.opacity = 0;
            setTimeout(()=> document.getElementById('envelope-layer').style.display = 'none', 500);
            const modal = document.getElementById('letter-modal');
            modal.style.display = 'flex'; void modal.offsetWidth; modal.style.opacity = 1;
            document.querySelector('.letter-paper').style.transform = 'translateY(0)';
            const contentEl = document.getElementById('letter-content');
            let idx = 0;
            const letterText = CONFIG.finalLetter;
            function typeLetter() {
                if(idx < letterText.length) {
                    const char = letterText.charAt(idx);
                    contentEl.innerHTML += char === '\n' ? '<br>' : char;
                    idx++;
                    // 滚动到底部
                    const paper = document.querySelector('.letter-paper');
                    paper.scrollTop = paper.scrollHeight;
                    setTimeout(typeLetter, 50);
                }
            }
            setTimeout(typeLetter, 1000);
        }

        function openPolaroid(starObj) {
            const data = starObj.userData.data;
            document.getElementById('p-img').src = data.src;
            document.getElementById('p-title').innerText = data.title;
            document.getElementById('p-sub').innerText = data.note;
            document.getElementById('p-date').innerText = data.date || "";
            if (CONFIG.radishPool.length > 0) {
                const rImg = document.getElementById('p-radish');
                rImg.src = CONFIG.radishPool[Math.floor(Math.random()*CONFIG.radishPool.length)];
                rImg.style.display = 'block';
            }
            const modal = document.getElementById('polaroid-modal');
            modal.style.display = 'flex'; modal.style.pointerEvents = 'auto';
            void modal.offsetWidth; modal.style.opacity = 1;
            document.getElementById('polaroid-card').classList.add('active');
        }

        function closePolaroid() {
            const modal = document.getElementById('polaroid-modal');
            modal.style.opacity = 0;
            document.getElementById('polaroid-card').classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none'; modal.style.pointerEvents = 'none';
                checkEndGame(); 
            }, 500);
        }

        function onResize() { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        function onTouchStart(e) { if(e.touches.length===1){ isDragging=true; previousTouch.x=e.touches[0].pageX; previousTouch.y=e.touches[0].pageY; rotationVelocity={x:0,y:0}; } }
        function onTouchMove(e) { if(isDragging && e.touches.length===1) { e.preventDefault(); const dx=e.touches[0].pageX-previousTouch.x; const dy=e.touches[0].pageY-previousTouch.y; starGroup.rotation.y+=dx*0.005; starGroup.rotation.x+=dy*0.005; rotationVelocity={x:dx*0.005,y:dy*0.005}; previousTouch.x=e.touches[0].pageX; previousTouch.y=e.touches[0].pageY; } }
        function onTouchEnd() { isDragging=false; }
        function onMouseDown(e) { isDragging=true; previousTouch.x=e.clientX; previousTouch.y=e.clientY; }
        function onMouseMove(e) { if(isDragging) { const dx=e.clientX-previousTouch.x; const dy=e.clientY-previousTouch.y; starGroup.rotation.y+=dx*0.005; starGroup.rotation.x+=dy*0.005; rotationVelocity={x:dx*0.005,y:dy*0.005}; previousTouch.x=e.clientX; previousTouch.y=e.clientY; } }
        function onMouseUp() { isDragging=false; }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            if(!isDragging) { starGroup.rotation.y += rotationVelocity.x + 0.0008; starGroup.rotation.x += rotationVelocity.y; rotationVelocity.x *= 0.95; rotationVelocity.y *= 0.95; }
            if(ambientParticles) ambientParticles.rotation.y -= 0.0002;

            if(meteorObject && !state.isFinaleTriggered) {
                const time = Date.now() * 0.002;
                meteorObject.position.x = Math.sin(time) * 150 + Math.cos(time * 1.3) * 50;
                meteorObject.position.y = Math.cos(time * 0.8) * 150 + Math.sin(time * 1.5) * 50;
                meteorObject.position.z = Math.sin(time * 0.5) * 100 + 100;
                if(meteorTrailSystem) meteorTrailSystem.update(meteorObject.position);
            }

            if(fireworkSystem) {
                const positions = fireworkSystem.geometry.attributes.position.array;
                const vels = fireworkSystem.geometry.userData.velocities;
                for(let i=0; i<positions.length; i+=3) {
                    positions[i] += vels[i] * 0.015;   
                    positions[i+1] += vels[i+1] * 0.015; 
                    positions[i+2] += vels[i+2] * 0.015; 
                    vels[i] *= 0.95; vels[i+1] *= 0.95; vels[i+2] *= 0.95;
                }
                fireworkSystem.geometry.attributes.position.needsUpdate = true;
                fireworkSystem.material.opacity -= 0.004; 
                if(fireworkSystem.material.opacity <= 0) {
                    scene.remove(fireworkSystem);
                    fireworkSystem = null;
                    showEnvelope();
                }
            }
            renderer.render(scene, camera);
        }

        window.handleImageError = handleImageError;
        window.showToast = showToast;
        window.startGalaxy = startGalaxy;
        window.refreshMemories = refreshMemories;
        window.closePolaroid = closePolaroid;
        window.triggerFinale = triggerFinale;
        window.openLetter = openLetter;
    </script>
</body>
</html>
