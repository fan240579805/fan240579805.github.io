<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>给最珍贵的你</title>
    <!-- 引入浪漫的中文手写字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    
    <style>
        /* --- 全局样式 --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 第一阶段：道歉信 UI --- */
        #intro-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1.5s ease-in-out;
        }

        .text-container {
            width: 80%;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            line-height: 2;
            min-height: 150px;
            text-align: left;
            white-space: pre-wrap;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            font-family: 'Ma Shan Zheng', cursive; 
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: white;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        .enter-btn {
            margin-top: 50px;
            padding: 12px 35px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 30px;
            font-size: 1.1rem;
            font-family: 'Ma Shan Zheng', cursive;
            cursor: pointer;
            opacity: 0; 
            transition: all 0.5s;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        .enter-btn:active {
            background: rgba(255,255,255,0.1);
            transform: scale(0.95);
        }

        /* --- 第二阶段：3D 画布 --- */
        #canvas-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            opacity: 0; 
            transition: opacity 2s;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
        }

        /* --- 第三阶段：拍立得弹窗 (交互优化版) --- */
        #polaroid-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 30;
            /* 允许点击穿透到背景，除非显示 */
            pointer-events: none; 
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s;
            /* 蒙层更透亮，高斯模糊更重 */
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .polaroid {
            position: relative;
            width: 280px;
            background: #fff;
            padding: 15px 15px 20px 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            transform: scale(0.8) rotate(-3deg);
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; /* 确保卡片可以点击 */
            display: flex;
            flex-direction: column;
            border-radius: 4px;
            overflow: visible; 
        }
        
        .polaroid.active {
            transform: scale(1) rotate(0deg);
        }

        .polaroid img.main-photo {
            width: 100%;
            height: auto;
            display: block;
            background: #f8f8f8; /* 图片未加载时的底色 */
            margin-bottom: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            min-height: 200px; /* 占位高度 */
            object-fit: cover;
        }

        /* 小萝卜装饰样式 - 固定在右上角 */
        .radish-deco {
            position: absolute;
            width: 75px; 
            height: auto;
            z-index: 10;
            filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.2));
            transition: all 0.3s;
            pointer-events: none;
            /* 右上角定位 */
            top: -30px;
            right: -25px;
            transform: rotate(15deg);
        }

        .polaroid-text {
            width: 100%;
            text-align: center;
            color: #333;
            font-family: 'Ma Shan Zheng', cursive; 
        }

        .polaroid-title {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .polaroid-sub {
            font-size: 1.1rem;
            color: #555;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .close-hint {
            position: absolute;
            bottom: -60px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* 引导提示 */
        #guide-hint {
            position: absolute;
            bottom: 10%;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 1rem;
            z-index: 10;
            pointer-events: none;
            animation: pulse 2s infinite;
            display: none;
            font-family: 'Ma Shan Zheng', cursive;
        }

        /* 刷新按钮区域 */
        .refresh-container {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 20;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        #refresh-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            pointer-events: auto;
            backdrop-filter: blur(5px);
            transition: transform 0.3s;
        }
        #refresh-btn:active {
            transform: rotate(180deg) scale(0.9);
        }

        /* --- Toast 提示样式 --- */
        .toast-container {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            pointer-events: none;
        }

        .toast {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 10px 24px;
            border-radius: 50px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

    </style>
    <!-- Three.js & Tween.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <!-- 1. 道歉信层 -->
    <div id="intro-layer">
        <div class="text-container">
            <span id="typewriter-text"></span><span class="cursor"></span>
        </div>
        <button class="enter-btn" id="enter-btn" onclick="startGalaxy()">去寻找遗失的光</button>
    </div>

    <!-- 2. 3D 场景层 -->
    <div id="canvas-container"></div>
    <div id="guide-hint">拖动星空 · 点击发光的星星</div>
    
    <!-- 刷新按钮 -->
    <div class="refresh-container" id="refresh-ui">
        <div id="refresh-btn" onclick="refreshMemories()">↻</div>
    </div>

    <!-- Toast 提示容器 -->
    <div class="toast-container">
        <div id="toast" class="toast">新的回忆碎片已送达 ✨</div>
    </div>

    <!-- 3. 拍立得展示层 (蒙层) -->
    <!-- onclick="closePolaroid()" 绑定在蒙层上 -->
    <div id="polaroid-modal" onclick="closePolaroid()">
        <!-- 阻止冒泡：点击卡片本身不关闭 -->
        <div class="polaroid" id="polaroid-card" onclick="event.stopPropagation()">
            <!-- 照片 (带兜底) -->
            <img id="p-img" class="main-photo" src="" alt="" onerror="handleImageError(this)">
            
            <!-- 萝卜装饰 (带兜底，加载失败则隐藏) -->
            <img id="p-radish" class="radish-deco" src="" style="display:none" onerror="this.style.display='none'">
            
            <div class="polaroid-text">
                <div class="polaroid-title" id="p-title"></div>
                <div class="polaroid-sub" id="p-sub"></div>
            </div>
            <div class="close-hint">点击背景关闭</div>
        </div>
    </div>

    <!-- 4. 背景音乐 -->
    <audio id="bgm" loop>
        <source src="https://music.163.com/song/media/outer/url?id=1387581250.mp3" type="audio/mpeg">
    </audio>

    <script>
        /* =========================================
           配置中心 (所有文案和图片在这里修改)
           ========================================= */
        const CONFIG = {
            // 1. 开头的引导语
            introText: 
                "对不起，\n" +
                "这几天天空好像都灰了。\n" +
                "我不善言辞，\n" +
                "所以把想说的话，藏在了这片星空里。\n" +
                "每一个发光的星星，\n" +
                "都是我想你的瞬间。",
            
            // 2. 回忆池
            memoryPool: [
                { 
                    src: "https://images.unsplash.com/photo-1516589178581-6cd7833ae3b2?w=600&q=80", 
                    title: "海边的风", 
                    note: "那天风很大，但我只听得见你的笑声。" 
                },
                { 
                    src: "https://images.unsplash.com/photo-1523438885200-e635ba2c371e?w=600&q=80", 
                    title: "小笨蛋", 
                    note: "其实每次你说我笨的时候，我都觉得很幸福。" 
                },
                { 
                    src: "https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?w=600&q=80", 
                    title: "对不起嘛", 
                    note: "我知道错了，罚我带你去吃好吃的行不行？" 
                },
                { 
                    src: "https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=600&q=80", 
                    title: "未来的家", 
                    note: "以后我们也要养一只这样的猫，好不好？" 
                },
                { 
                    src: "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=600&q=80", 
                    title: "你的侧脸", 
                    note: "百看不厌，想就这么一直看着你变老。" 
                }
            ],

            // 3. 小萝卜装饰图片池
            radishPool: [
                "https://img.icons8.com/stickers/100/flower-doodle.png", 
                "https://img.icons8.com/stickers/100/potted-plant-doodle.png",
                "https://img.icons8.com/fluency/96/cute-pumpkin.png"
            ],
            
            displayCount: 5 
        };

        // 兜底占位图 (Base64，防止外部链接也挂掉)
        // 一个简单的淡粉色方块，带爱心
        const PLACEHOLDER_IMG = "data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'%3e%3crect width='400' height='400' fill='%23fff0f5'/%3e%3ctext x='50%25' y='50%25' font-family='sans-serif' font-size='24' fill='%23ffb6c1' dominant-baseline='middle' text-anchor='middle'%3eLove Memory%3c/text%3e%3c/svg%3e";

        // 图片加载失败处理
        function handleImageError(img) {
            img.onerror = null; // 防止循环触发
            img.src = PLACEHOLDER_IMG;
        }

        /* =========================================
           逻辑实现区
           ========================================= */

        // --- Toast 提示功能 ---
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- 阶段1：打字机 ---
        const textEl = document.getElementById('typewriter-text');
        const enterBtn = document.getElementById('enter-btn');
        let charIndex = 0;

        function typeWriter() {
            if (charIndex < CONFIG.introText.length) {
                const char = CONFIG.introText.charAt(charIndex);
                textEl.innerHTML += char === '\n' ? '<br>' : char;
                charIndex++;
                setTimeout(typeWriter, 80 + Math.random() * 100);
            } else {
                document.querySelector('.cursor').style.display = 'none';
                enterBtn.style.opacity = 1;
                enterBtn.style.pointerEvents = 'auto';
            }
        }
        setTimeout(typeWriter, 1000);

        // --- 阶段2：Three.js 星空 ---
        let scene, camera, renderer;
        let starGroup; 
        let activeMemoryStars = []; 
        let ambientParticles; 
        let raycaster, mouse;
        let isDragging = false;
        let previousTouch = { x: 0, y: 0 };
        let rotationVelocity = { x: 0, y: 0 };
        
        const container = document.getElementById('canvas-container');

        function startGalaxy() {
            const bgm = document.getElementById('bgm');
            bgm.play().catch(() => console.log('BGM需要交互才能播放'));

            document.getElementById('intro-layer').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('intro-layer').style.display = 'none';
                container.style.opacity = 1;
                document.getElementById('guide-hint').style.display = 'block';
                
                const refreshUI = document.getElementById('refresh-ui');
                refreshUI.style.display = 'flex';
                initThreeJS();

                setTimeout(() => {
                   showToast("点击刷新可以重置星空哦 ↻");
                }, 2000);

            }, 1500);
        }

        function initThreeJS() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.0015);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.z = 450;

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            starGroup = new THREE.Group();
            scene.add(starGroup);

            createAmbientParticles();
            spawnMemoryStars();

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('resize', onResize);
            
            document.addEventListener('touchstart', onTouchStart, {passive: false});
            document.addEventListener('touchmove', onTouchMove, {passive: false});
            document.addEventListener('touchend', onTouchEnd, {passive: false});
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            renderer.domElement.addEventListener('click', onClick);

            animate();
        }

        function createAmbientParticles() {
            const geom = new THREE.BufferGeometry();
            const vertices = [];
            const colors = [];
            const particleCount = 5000; 

            const colorPalette = [
                new THREE.Color(1, 1, 1), 
                new THREE.Color(1, 1, 1), 
                new THREE.Color(1, 0.9, 0.95), 
                new THREE.Color(0.95, 0.9, 1), 
                new THREE.Color(0.9, 0.95, 1)  
            ];

            for(let i=0; i<particleCount; i++) {
                vertices.push(
                    (Math.random()-0.5) * 2500,
                    (Math.random()-0.5) * 2500,
                    (Math.random()-0.5) * 2500
                );
                
                const color = colorPalette[Math.floor(Math.random() * colorPalette.length)];
                colors.push(color.r, color.g, color.b);
            }

            geom.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geom.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const mat = new THREE.PointsMaterial({ 
                size: Math.random() * 3 + 2, 
                vertexColors: true, 
                transparent: true, 
                opacity: 0.9, 
                blending: THREE.AdditiveBlending,
                map: createLightTexture(), 
                depthWrite: false
            });

            ambientParticles = new THREE.Points(geom, mat);
            starGroup.add(ambientParticles);
        }

        function createLightTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(16,16,0, 16,16,16);
            grad.addColorStop(0, 'rgba(255,255,255,1)');
            grad.addColorStop(0.5, 'rgba(255,255,255,0.5)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(canvas);
        }

        function spawnMemoryStars() {
            activeMemoryStars.forEach(s => starGroup.remove(s));
            activeMemoryStars = [];

            const shuffled = [...CONFIG.memoryPool].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, CONFIG.displayCount);

            const texture = createLightTexture();
            const material = new THREE.SpriteMaterial({ 
                map: texture, 
                color: 0xffffff, 
                transparent: true,
                opacity: 0, 
                blending: THREE.AdditiveBlending
            });

            const phi = Math.PI * (3 - Math.sqrt(5));
            const radius = 200; 

            selected.forEach((data, i) => {
                const y = 1 - (i / (selected.length - 1)) * 2; 
                const r = Math.sqrt(1 - y * y);
                const theta = phi * i * 10; 
                
                const x = Math.cos(theta) * r * radius;
                const z = Math.sin(theta) * r * radius;

                const star = new THREE.Sprite(material.clone());
                star.position.set(
                    x + (Math.random()-0.5)*100, 
                    y * radius + (Math.random()-0.5)*50, 
                    z + (Math.random()-0.5)*100
                );
                
                star.scale.set(1, 1, 1);
                star.userData = { isMemory: true, data: data };
                
                starGroup.add(star);
                activeMemoryStars.push(star);

                new TWEEN.Tween(star.material)
                    .to({ opacity: 0.9 }, 1000).delay(i*200).start();
                new TWEEN.Tween(star.scale)
                    .to({ x: 40, y: 40 }, 1000).delay(i*200)
                    .easing(TWEEN.Easing.Back.Out).start();
                
                new TWEEN.Tween(star.scale)
                    .to({ x: 45, y: 45 }, 1500 + Math.random()*500)
                    .yoyo(true).repeat(Infinity).delay(1000 + i*200).start();
            });
        }

        function refreshMemories() {
            const btn = document.getElementById('refresh-btn');
            btn.style.transform = "rotate(360deg)";
            setTimeout(() => btn.style.transform = "rotate(0deg)", 500);

            showToast("宇宙正在重组... 新的星星出现了 ✨");

            activeMemoryStars.forEach(star => {
                new TWEEN.Tween(star.scale).to({x:0, y:0}, 500).start();
                new TWEEN.Tween(star.material).to({opacity:0}, 500).start();
            });

            setTimeout(() => {
                spawnMemoryStars();
            }, 600);
        }

        // --- 交互逻辑 ---
        function onTouchStart(e) {
            if(e.touches.length === 1) {
                isDragging = true;
                previousTouch.x = e.touches[0].pageX;
                previousTouch.y = e.touches[0].pageY;
                rotationVelocity = {x:0, y:0};
            }
        }
        function onTouchMove(e) {
            if(isDragging && e.touches.length === 1) {
                e.preventDefault();
                const dx = e.touches[0].pageX - previousTouch.x;
                const dy = e.touches[0].pageY - previousTouch.y;
                starGroup.rotation.y += dx * 0.005;
                starGroup.rotation.x += dy * 0.005;
                rotationVelocity = {x: dx*0.005, y: dy*0.005};
                previousTouch.x = e.touches[0].pageX;
                previousTouch.y = e.touches[0].pageY;
            }
        }
        function onTouchEnd() { isDragging = false; }

        function onMouseDown(e) {
            isDragging = true;
            previousTouch.x = e.clientX;
            previousTouch.y = e.clientY;
        }
        function onMouseMove(e) {
            if(isDragging) {
                const dx = e.clientX - previousTouch.x;
                const dy = e.clientY - previousTouch.y;
                starGroup.rotation.y += dx * 0.005;
                starGroup.rotation.x += dy * 0.005;
                rotationVelocity = {x: dx*0.005, y: dy*0.005};
                previousTouch.x = e.clientX;
                previousTouch.y = e.clientY;
            }
        }
        function onMouseUp() { isDragging = false; }

        function onClick(event) {
            if(Math.abs(rotationVelocity.x) > 0.01 || Math.abs(rotationVelocity.y) > 0.01) return;

            let clientX = event.clientX;
            let clientY = event.clientY;
            if(event.changedTouches && event.changedTouches.length > 0) {
                clientX = event.changedTouches[0].clientX;
                clientY = event.changedTouches[0].clientY;
            }

            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(activeMemoryStars);

            if (intersects.length > 0) {
                openPolaroid(intersects[0].object);
            }
        }

        // --- 拍立得逻辑 ---
        const modal = document.getElementById('polaroid-modal');
        const pCard = document.getElementById('polaroid-card');
        const pImg = document.getElementById('p-img');
        const pRadish = document.getElementById('p-radish');
        const pTitle = document.getElementById('p-title');
        const pSub = document.getElementById('p-sub');

        function openPolaroid(starObj) {
            const data = starObj.userData.data;
            pImg.src = data.src;
            pTitle.innerText = data.title;
            pSub.innerText = data.note;

            // 随机选择一个小萝卜，并固定显示在右上角
            if (CONFIG.radishPool && CONFIG.radishPool.length > 0) {
                const randomRadish = CONFIG.radishPool[Math.floor(Math.random() * CONFIG.radishPool.length)];
                pRadish.src = randomRadish;
                pRadish.style.display = 'block';
                // 样式已经在CSS类 .radish-deco 中固定为右上角，这里重置一下transform以免受之前逻辑影响
                pRadish.style.transform = 'rotate(15deg)';
            } else {
                pRadish.style.display = 'none';
            }

            modal.style.display = 'flex';
            modal.style.pointerEvents = 'auto'; // 允许点击背景关闭
            void modal.offsetWidth; 
            modal.style.opacity = 1;
            pCard.classList.add('active');
        }

        function closePolaroid() {
            modal.style.opacity = 0;
            pCard.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.style.pointerEvents = 'none'; 
            }, 500);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();

            if(!isDragging) {
                starGroup.rotation.y += rotationVelocity.x;
                starGroup.rotation.x += rotationVelocity.y;
                rotationVelocity.x *= 0.95;
                rotationVelocity.y *= 0.95;
                starGroup.rotation.y += 0.0008;
            }
            
            if(ambientParticles) {
                ambientParticles.rotation.y -= 0.0002;
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
